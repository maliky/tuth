{% extends "website/staff/base.html" %}

{% block header_actions %}
  <a class="btn btn-outline-secondary btn-sm" href="{% url 'student_list' %}">
    Back to snapshot
  </a>
{% endblock %}

{% block staff_content %}
  <div class="card shadow-sm">
    <div class="card-body">
      <h2 class="h5 mb-3">Jump to Django admin</h2>
      <p class="text-muted">
        Pick a student and Tusis will open the Django admin edit form in a new tab.
      </p>
      <form method="post" class="row g-3" novalidate>
        {% csrf_token %}
        <div class="col-md-8">
          {{ form.student_query.label_tag }}
          <div class="autocomplete-wrapper">
            {{ form.student_query.as_widget(attrs={
              "class": "form-control autocomplete-input",
              "data-autocomplete-url": autocomplete_url,
              "aria-describedby": "student-autocomplete-help",
              "autocomplete": "off",
            }) }}
            {{ form.student }}
            <div class="autocomplete-dropdown visually-hidden" id="student-autocomplete">
              <span class="autocomplete-empty">
                Start typing a student ID or name to search.
              </span>
            </div>
          </div>
          <div id="student-autocomplete-help" class="form-text">
            Search by student ID or name; only enrolled students appear.
          </div>
          {% if form.student_query.errors %}
            <div class="text-danger small mt-1">
              {{ form.student_query.errors|join:", " }}
            </div>
          {% endif %}
          {% if form.non_field_errors %}
            <div class="text-danger small mt-1">
              {{ form.non_field_errors|join:", " }}
            </div>
          {% endif %}
        </div>
        <div class="col-md-4 d-flex align-items-end">
          <button type="submit" class="btn btn-primary w-100">Open in admin</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    (() => {
      const wrapper = document.querySelector(".autocomplete-wrapper");
      if (!wrapper) {
        return;
      }
      const input = wrapper.querySelector("[name='student_query']");
      const hidden = wrapper.querySelector("[name='student']");
      const dropdown = document.getElementById("student-autocomplete");
      const url = input?.dataset.autocompleteUrl;
      let timer;

      const hideDropdown = () => {
        dropdown.classList.add("visually-hidden");
      };

      const showDropdown = () => {
        dropdown.classList.remove("visually-hidden");
      };

      const renderResults = (items) => {
        if (!items.length) {
          dropdown.innerHTML = "<span class='autocomplete-empty'>No matches found.</span>";
          return showDropdown();
        }
        dropdown.innerHTML = "";
        items.forEach((item) => {
          const button = document.createElement("button");
          button.type = "button";
          button.className = "autocomplete-item";
          button.dataset.pk = item.pk;
          button.dataset.label = item.label;
          const span = document.createElement("span");
          span.textContent = item.label;
          if (item.curriculum) {
            const subtitle = document.createElement("small");
            subtitle.textContent = item.curriculum;
            span.appendChild(subtitle);
          }
          button.appendChild(span);
          dropdown.appendChild(button);
        });
        showDropdown();
      };

      const fetchSuggestions = async () => {
        const query = (input.value || "").trim();
        if (!url || query.length < 2) {
          hideDropdown();
          return;
        }
        try {
          const response = await fetch(`${url}?q=${encodeURIComponent(query)}`);
          if (!response.ok) {
            throw new Error("Unable to load suggestions.");
          }
          const payload = await response.json();
          renderResults(payload.results);
        } catch {
          dropdown.innerHTML =
            "<span class='autocomplete-empty'>Unable to reach the autocomplete service.</span>";
          showDropdown();
        }
      };

      input.addEventListener("input", () => {
        hidden.value = "";
        clearTimeout(timer);
        const text = (input.value || "").trim();
        if (text.length < 2) {
          dropdown.innerHTML =
            "<span class='autocomplete-empty'>Keep typing to search students.</span>";
          return showDropdown();
        }
        timer = window.setTimeout(fetchSuggestions, 250);
      });

      dropdown.addEventListener("click", (event) => {
        const button = event.target.closest(".autocomplete-item");
        if (!button) {
          return;
        }
        hidden.value = button.dataset.pk;
        input.value = button.dataset.label;
        hideDropdown();
        input.focus();
      });

      document.addEventListener("click", (event) => {
        if (!wrapper.contains(event.target)) {
          hideDropdown();
        }
      });

      input.addEventListener("focus", () => {
        if (dropdown.innerHTML.trim()) {
          showDropdown();
        }
      });
    })();
  </script>
{% endblock %}
