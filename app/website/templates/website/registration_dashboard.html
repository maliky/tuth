{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Registration Dashboard</title>
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" />
  </head>
  <body class="p-4">
    <h1 class="mb-4">Course Registration</h1>
    {% if messages %}
    <div class="mb-3">
      {% for message in messages %}
        <div class="alert alert-info">{{ message }}</div>
      {% endfor %}
    </div>
    {% endif %}
    <form method="post">
      {% csrf_token %}
      <div class="mb-3 d-flex gap-2">
        <select name="action" class="form-select form-select-sm w-auto">
          <option value="reserve">Reserve</option>
          <option value="cancel">Cancel Reservation</option>
        </select>
        <button type="submit" class="btn btn-primary btn-sm">Submit</button>
      </div>
      <div class="accordion" id="courses">
        {% for course, sections in sections_by_course.items %}
        <div class="accordion-item">
          <h2 class="accordion-header" id="heading{{ forloop.counter }}">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#course{{ forloop.counter }}" aria-expanded="false">
              {{ course }}
            </button>
          </h2>
          <div id="course{{ forloop.counter }}" class="accordion-collapse collapse" data-bs-parent="#courses">
            <div class="accordion-body">
              {% for sec in sections %}
              <div class="form-check">
                <input class="form-check-input section-checkbox" type="checkbox" name="sections" value="{{ sec.id }}" data-course="{{ course.id }}" data-credits="{{ sec.program.credit_hours }}" data-fee="{{ sec.fee_amount }}" {% if sec.id in existing %}checked{% endif %}>
                <label class="form-check-label">
                  Section {{ sec.number }}:
                  {% for sess in sec.sessions.all %}
                    {{ sess.schedule }}{% if not forloop.last %}, {% endif %}
                  {% endfor %}
                </label>
              </div>
              {% endfor %}
            </div>
          </div>
        </div>
        {% empty %}
        <p>No available courses.</p>
        {% endfor %}
      </div>
      <div class="mt-3">
        <strong>Total Credits:</strong> <span id="total-credits">0</span><br />
        <strong>Total Cost:</strong> $<span id="total-cost">0.00</span>
      </div>
    </form>
    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script>
    (function() {
      const checkboxes = document.querySelectorAll('.section-checkbox');
      function updateTotals() {
        let credits = 0;
        let cost = 0;
        checkboxes.forEach(cb => {
          if (cb.checked) {
            credits += parseFloat(cb.dataset.credits || 0);
            cost += parseFloat(cb.dataset.fee || 0);
          }
        });
        document.getElementById('total-credits').textContent = credits;
        document.getElementById('total-cost').textContent = cost.toFixed(2);
      }
      checkboxes.forEach(cb => {
        cb.addEventListener('change', () => {
          if (cb.checked) {
            document.querySelectorAll('.section-checkbox[data-course="' + cb.dataset.course + '"]').forEach(other => {
              if (other !== cb) other.checked = false;
            });
          }
          updateTotals();
        });
      });
      updateTotals();
    })();
    </script>
  </body>
</html>
